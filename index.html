<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GradeTracker - Course &amp; Assignment Manager</title>
  <style>
    /* Design System */
    :root {
      --color-white: rgba(255, 255, 255, 1);
      --color-black: rgba(0, 0, 0, 1);
      --color-cream-50: rgba(252, 252, 249, 1);
      --color-cream-100: rgba(255, 255, 253, 1);
      --color-gray-200: rgba(245, 245, 245, 1);
      --color-gray-300: rgba(167, 169, 169, 1);
      --color-gray-400: rgba(119, 124, 124, 1);
      --color-slate-500: rgba(98, 108, 113, 1);
      --color-brown-600: rgba(94, 82, 64, 1);
      --color-charcoal-700: rgba(31, 33, 33, 1);
      --color-charcoal-800: rgba(38, 40, 40, 1);
      --color-slate-900: rgba(19, 52, 59, 1);
      --color-teal-300: rgba(50, 184, 198, 1);
      --color-teal-400: rgba(45, 166, 178, 1);
      --color-teal-500: rgba(33, 128, 141, 1);
      --color-teal-600: rgba(29, 116, 128, 1);
      --color-teal-700: rgba(26, 104, 115, 1);
      --color-red-400: rgba(255, 84, 89, 1);
      --color-red-500: rgba(192, 21, 47, 1);
      --color-orange-400: rgba(230, 129, 97, 1);
      --color-orange-500: rgba(168, 75, 47, 1);

      --color-brown-600-rgb: 94, 82, 64;
      --color-teal-500-rgb: 33, 128, 141;
      --color-slate-900-rgb: 19, 52, 59;
      --color-slate-500-rgb: 98, 108, 113;

      --color-bg-1: rgba(59, 130, 246, 0.08);
      --color-bg-2: rgba(245, 158, 11, 0.08);
      --color-bg-3: rgba(34, 197, 94, 0.08);
      --color-bg-4: rgba(239, 68, 68, 0.08);

      --color-background: var(--color-cream-50);
      --color-surface: var(--color-cream-100);
      --color-text: var(--color-slate-900);
      --color-text-secondary: var(--color-slate-500);
      --color-primary: var(--color-teal-500);
      --color-primary-hover: var(--color-teal-600);
      --color-primary-active: var(--color-teal-700);
      --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
      --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
      --color-border: rgba(var(--color-brown-600-rgb), 0.2);
      --color-btn-primary-text: var(--color-cream-50);
      --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
      --color-error: var(--color-red-500);
      --color-success: var(--color-teal-500);

      --font-family-base: "FKGroteskNeue", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --font-size-xs: 11px;
      --font-size-sm: 12px;
      --font-size-base: 14px;
      --font-size-lg: 16px;
      --font-size-xl: 18px;
      --font-size-2xl: 20px;
      --font-size-3xl: 24px;
      --font-size-4xl: 30px;
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 550;
      --font-weight-bold: 600;
      --line-height-tight: 1.2;
      --line-height-normal: 1.5;

      --space-4: 4px;
      --space-8: 8px;
      --space-12: 12px;
      --space-16: 16px;
      --space-20: 20px;
      --space-24: 24px;
      --space-32: 32px;
      --space-48: 48px;

      --radius-sm: 6px;
      --radius-base: 8px;
      --radius-md: 10px;
      --radius-lg: 12px;
      --radius-full: 9999px;

      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --color-gray-400-rgb: 119, 124, 124;
        --color-teal-300-rgb: 50, 184, 198;
        --color-gray-300-rgb: 167, 169, 169;
        --color-gray-200-rgb: 245, 245, 245;

        --color-background: var(--color-charcoal-700);
        --color-surface: var(--color-charcoal-800);
        --color-text: var(--color-gray-200);
        --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
        --color-primary: var(--color-teal-300);
        --color-primary-hover: var(--color-teal-400);
        --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
        --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
        --color-border: rgba(var(--color-gray-400-rgb), 0.3);
        --color-btn-primary-text: var(--color-slate-900);
        --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
        --color-error: var(--color-red-400);
        --color-success: var(--color-teal-300);
      }
    }

    @font-face {
      font-family: 'FKGroteskNeue';
      src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2') format('woff2');
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-family-base);
      background-color: var(--color-background);
      color: var(--color-text);
      font-size: var(--font-size-base);
      line-height: var(--line-height-normal);
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--space-24);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-32);
    }

    .header h1 {
      font-size: var(--font-size-4xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-text);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-12) var(--space-20);
      border-radius: var(--radius-base);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--color-primary);
      color: var(--color-btn-primary-text);
    }

    .btn-primary:hover {
      background: var(--color-primary-hover);
    }

    .btn-secondary {
      background: var(--color-secondary);
      color: var(--color-text);
    }

    .btn-secondary:hover {
      background: var(--color-secondary-hover);
    }

    .btn-danger {
      background: var(--color-error);
      color: white;
    }

    .btn-sm {
      padding: var(--space-8) var(--space-16);
      font-size: var(--font-size-sm);
    }

    .card {
      background: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-lg);
      padding: var(--space-24);
      box-shadow: var(--shadow-sm);
      transition: box-shadow 0.2s;
    }

    .card:hover {
      box-shadow: var(--shadow-md);
    }

    .welcome-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
      text-align: center;
    }

    .welcome-screen h1 {
      font-size: var(--font-size-4xl);
      margin-bottom: var(--space-16);
    }

    .welcome-screen p {
      font-size: var(--font-size-lg);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-32);
    }

    .welcome-buttons {
      display: flex;
      gap: var(--space-16);
    }

    .auth-form {
      max-width: 450px;
      margin: 0 auto;
      padding: var(--space-32);
    }

    .form-group {
      margin-bottom: var(--space-20);
    }

    .form-label {
      display: block;
      font-weight: var(--font-weight-medium);
      margin-bottom: var(--space-8);
      font-size: var(--font-size-sm);
    }

    .form-control {
      width: 100%;
      padding: var(--space-12);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      font-size: var(--font-size-base);
      background: var(--color-surface);
      color: var(--color-text);
      transition: border-color 0.2s;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--color-primary);
    }

    .error-message {
      color: var(--color-error);
      font-size: var(--font-size-sm);
      margin-top: var(--space-8);
    }

    .success-message {
      color: var(--color-success);
      font-size: var(--font-size-sm);
      margin-top: var(--space-8);
      padding: var(--space-12);
      background: var(--color-bg-3);
      border-radius: var(--radius-base);
    }

    .courses-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: var(--space-24);
      margin-bottom: var(--space-32);
    }

    .course-card {
      background: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-lg);
      padding: var(--space-24);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .course-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .course-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-16);
    }

    .course-color-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
    }

    .course-name {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--space-4);
    }

    .course-code {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }

    .course-stats {
      display: flex;
      flex-direction: column;
      gap: var(--space-8);
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      font-size: var(--font-size-sm);
    }

    .stat-label {
      color: var(--color-text-secondary);
    }

    .stat-value {
      font-weight: var(--font-weight-semibold);
    }

    .grade-badge {
      display: inline-block;
      padding: var(--space-4) var(--space-12);
      border-radius: var(--radius-full);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: white;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: var(--space-24);
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-32);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-24);
    }

    .modal-title {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-semibold);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: var(--font-size-2xl);
      cursor: pointer;
      color: var(--color-text-secondary);
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-base);
    }

    .close-btn:hover {
      background: var(--color-secondary);
    }

    .empty-state {
      text-align: center;
      padding: var(--space-48);
      color: var(--color-text-secondary);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: var(--space-16);
    }

    .assignments-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-16);
    }

    .assignment-item {
      background: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-base);
      padding: var(--space-16);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .assignment-info {
      flex: 1;
    }

    .assignment-name {
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--space-4);
    }

    .assignment-details {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }

    .assignment-actions {
      display: flex;
      gap: var(--space-8);
    }

    .icon-btn {
      background: none;
      border: none;
      padding: var(--space-8);
      cursor: pointer;
      color: var(--color-text-secondary);
      border-radius: var(--radius-base);
      transition: all 0.2s;
    }

    .icon-btn:hover {
      background: var(--color-secondary);
      color: var(--color-text);
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-32);
      color: var(--color-text-secondary);
    }

    .hidden {
      display: none !important;
    }

    .back-btn {
      margin-bottom: var(--space-24);
    }

    .course-detail-header {
      background: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-lg);
      padding: var(--space-24);
      margin-bottom: var(--space-24);
    }

    .calculations {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-16);
      margin-top: var(--space-24);
    }

    .calc-item {
      background: var(--color-bg-1);
      padding: var(--space-16);
      border-radius: var(--radius-base);
    }

    .calc-label {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-4);
    }

    .calc-value {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
    }

    .color-picker {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-8);
    }

    .color-option {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-base);
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .color-option:hover {
      transform: scale(1.1);
    }

    .color-option.selected {
      border-color: var(--color-text);
      box-shadow: 0 0 0 2px var(--color-surface);
    }

    .link-btn {
      background: none;
      border: none;
      color: var(--color-primary);
      cursor: pointer;
      font-size: var(--font-size-sm);
      text-decoration: underline;
      padding: 0;
      margin-top: var(--space-8);
    }

    .link-btn:hover {
      color: var(--color-primary-hover);
    }

    .info-box {
      background: var(--color-bg-3);
      border: 1px solid var(--color-success);
      border-radius: var(--radius-base);
      padding: var(--space-16);
      margin-bottom: var(--space-20);
      font-size: var(--font-size-sm);
    }

    @media (max-width: 768px) {
      .container {
        padding: var(--space-16);
      }

      .welcome-buttons {
        flex-direction: column;
        width: 100%;
      }

      .welcome-buttons .btn {
        width: 100%;
      }

      .courses-grid {
        grid-template-columns: 1fr;
      }

      .calculations {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="welcome-screen">
      <h1>üìö GradeTracker</h1>
      <p>Track your courses, assignments, and calculate your grades effortlessly</p>
      <div class="welcome-buttons">
        <button class="btn btn-primary" onclick="showLogin()">Login</button>
        <button class="btn btn-secondary" onclick="showRegister()">Create Account</button>
      </div>
    </div>

    <!-- Login Form -->
    <div id="loginScreen" class="auth-form hidden">
      <div class="card">
        <h2 style="margin-bottom: var(--space-24);">Login to GradeTracker</h2>
        <form onsubmit="handleLogin(event)">
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" id="loginEmail" class="form-control" required>
          </div>
          <div class="form-group">
            <label class="form-label">Password</label>
            <input type="password" id="loginPassword" class="form-control" required>
          </div>
          <div id="loginError" class="error-message hidden"></div>
          <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: var(--space-16);">Login</button>
        </form>
        <button class="link-btn" onclick="showWelcome()" style="margin-top: var(--space-16); display: block; text-align: center; width: 100%;">Back to Welcome</button>
      </div>
    </div>

    <!-- Register Form -->
    <div id="registerScreen" class="auth-form hidden">
      <div class="card">
        <h2 style="margin-bottom: var(--space-24);">Create Your Account</h2>
        <form onsubmit="handleRegister(event)">
          <div class="form-group">
            <label class="form-label">Username</label>
            <input type="text" id="registerUsername" class="form-control" required>
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" id="registerEmail" class="form-control" required>
          </div>
          <div class="form-group">
            <label class="form-label">Password</label>
            <input type="password" id="registerPassword" class="form-control" minlength="6" required>
          </div>
          <div class="form-group">
            <label class="form-label">Confirm Password</label>
            <input type="password" id="registerConfirmPassword" class="form-control" minlength="6" required>
          </div>
          <div id="registerError" class="error-message hidden"></div>
          <div id="registerSuccess" class="success-message hidden"></div>
          <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: var(--space-16);">Create Account</button>
        </form>
        <button class="link-btn" onclick="showWelcome()" style="margin-top: var(--space-16); display: block; text-align: center; width: 100%;">Back to Welcome</button>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardScreen" class="hidden">
      <div class="header">
        <div>
          <h1>üìö My Courses</h1>
          <p style="color: var(--color-text-secondary); margin-top: var(--space-8);">Welcome back, <span id="userName"></span>!</p>
        </div>
        <div style="display: flex; gap: var(--space-12);">
          <button class="btn btn-primary" onclick="showAddCourseModal()">+ Add Course</button>
          <button class="btn btn-secondary" onclick="handleLogout()">Logout</button>
        </div>
      </div>

      <div id="coursesLoading" class="loading hidden">
        <p>Loading your courses...</p>
      </div>

      <div id="coursesGrid" class="courses-grid"></div>

      <div id="emptyState" class="empty-state hidden">
        <div class="empty-state-icon">üìù</div>
        <h3 style="margin-bottom: var(--space-8);">No courses yet</h3>
        <p>Get started by adding your first course!</p>
        <button class="btn btn-primary" onclick="showAddCourseModal()" style="margin-top: var(--space-16);">+ Add Your First Course</button>
      </div>
    </div>

    <!-- Course Detail Screen -->
    <div id="courseDetailScreen" class="hidden">
      <button class="btn btn-secondary back-btn" onclick="showDashboard()">‚Üê Back to Courses</button>

      <div class="course-detail-header">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-16);">
          <div>
            <h2 id="detailCourseName" style="margin-bottom: var(--space-8);"></h2>
            <p id="detailCourseCode" style="color: var(--color-text-secondary);"></p>
          </div>
          <div style="display: flex; gap: var(--space-8);">
            <button class="btn btn-sm btn-secondary" onclick="editCurrentCourse()">Edit Course</button>
            <button class="btn btn-sm btn-danger" onclick="deleteCurrentCourse()">Delete</button>
          </div>
        </div>

        <div class="calculations">
          <div class="calc-item">
            <div class="calc-label">Current Grade</div>
            <div class="calc-value" id="currentGrade">-</div>
          </div>
          <div class="calc-item">
            <div class="calc-label">Target Grade</div>
            <div class="calc-value" id="targetGrade">-</div>
          </div>
          <div class="calc-item">
            <div class="calc-label">Completion</div>
            <div class="calc-value" id="completionPercent">-</div>
          </div>
          <div class="calc-item">
            <div class="calc-label">Required Final</div>
            <div class="calc-value" id="requiredFinal">-</div>
          </div>
        </div>
      </div>

      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-16);">
        <h3>Assignments</h3>
        <button class="btn btn-primary btn-sm" onclick="showAddAssignmentModal()">+ Add Assignment</button>
      </div>

      <div id="assignmentsLoading" class="loading hidden">
        <p>Loading assignments...</p>
      </div>

      <div id="assignmentsList" class="assignments-list"></div>

      <div id="emptyAssignments" class="empty-state hidden">
        <div class="empty-state-icon">üìã</div>
        <h4 style="margin-bottom: var(--space-8);">No assignments yet</h4>
        <p>Add your first assignment to start tracking your grades</p>
      </div>
    </div>
  </div>

  <!-- Add/Edit Course Modal -->
  <div id="courseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="courseModalTitle">Add Course</h3>
        <button class="close-btn" onclick="closeCourseModal()">√ó</button>
      </div>
      <form onsubmit="handleSaveCourse(event)">
        <div class="form-group">
          <label class="form-label">Course Name</label>
          <input type="text" id="courseName" class="form-control" placeholder="Introduction to Computer Science" required>
        </div>
        <div class="form-group">
          <label class="form-label">Course Code</label>
          <input type="text" id="courseCode" class="form-control" placeholder="CS101" required>
        </div>
        <div class="form-group">
          <label class="form-label">Target Grade (%)</label>
          <input type="number" id="targetGrade" class="form-control" min="0" max="100" step="0.1" placeholder="85" required>
        </div>
        <div class="form-group">
          <label class="form-label">Course Color</label>
          <div class="color-picker" id="colorPicker"></div>
        </div>
        <div id="courseModalError" class="error-message hidden"></div>
        <div style="display: flex; gap: var(--space-12); margin-top: var(--space-24);">
          <button type="submit" class="btn btn-primary" style="flex: 1;">Save Course</button>
          <button type="button" class="btn btn-secondary" onclick="closeCourseModal()" style="flex: 1;">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add/Edit Assignment Modal -->
  <div id="assignmentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="assignmentModalTitle">Add Assignment</h3>
        <button class="close-btn" onclick="closeAssignmentModal()">√ó</button>
      </div>
      <form onsubmit="handleSaveAssignment(event)">
        <div class="form-group">
          <label class="form-label">Assignment Name</label>
          <input type="text" id="assignmentName" class="form-control" placeholder="Midterm Exam" required>
        </div>
        <div class="form-group">
          <label class="form-label">Grade (%)</label>
          <input type="number" id="assignmentGrade" class="form-control" min="0" max="100" step="0.1" placeholder="85" required>
        </div>
        <div class="form-group">
          <label class="form-label">Weight (%)</label>
          <input type="number" id="assignmentWeight" class="form-control" min="0" max="100" step="0.1" placeholder="30" required>
        </div>
        <div class="form-group">
          <label class="form-label">Type</label>
          <select id="assignmentType" class="form-control" required>
            <option value="">Select type...</option>
            <option value="Homework">Homework</option>
            <option value="Quiz">Quiz</option>
            <option value="Test">Test</option>
            <option value="Midterm Exam">Midterm Exam</option>
            <option value="Final Exam">Final Exam</option>
            <option value="Project">Project</option>
            <option value="Lab">Lab</option>
            <option value="Participation">Participation</option>
            <option value="Assignment">Assignment</option>
            <option value="Paper">Paper</option>
            <option value="Presentation">Presentation</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Due Date (Optional)</label>
          <input type="date" id="assignmentDate" class="form-control">
        </div>
        <div id="assignmentModalError" class="error-message hidden"></div>
        <div style="display: flex; gap: var(--space-12); margin-top: var(--space-24);">
          <button type="submit" class="btn btn-primary" style="flex: 1;">Save Assignment</button>
          <button type="button" class="btn btn-secondary" onclick="closeAssignmentModal()" style="flex: 1;">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Global state
    let currentUser = null;
    let courses = [];
    let currentCourse = null;
    let assignments = [];
    let editingCourseId = null;
    let editingAssignmentId = null;

    const API_BASE = '/api';

    const courseColors = [
      { name: 'Blue', value: 'blue', hex: '#3b82f6' },
      { name: 'Green', value: 'green', hex: '#10b981' },
      { name: 'Purple', value: 'purple', hex: '#8b5cf6' },
      { name: 'Orange', value: 'orange', hex: '#f97316' },
      { name: 'Pink', value: 'pink', hex: '#ec4899' },
      { name: 'Teal', value: 'teal', hex: '#14b8a6' },
      { name: 'Red', value: 'red', hex: '#ef4444' },
      { name: 'Yellow', value: 'yellow', hex: '#eab308' }
    ];

    const gradeScale = {
      'A+': { min: 97, max: 100, color: '#10b981' },
      'A': { min: 93, max: 96, color: '#10b981' },
      'A-': { min: 90, max: 92, color: '#10b981' },
      'B+': { min: 87, max: 89, color: '#3b82f6' },
      'B': { min: 83, max: 86, color: '#3b82f6' },
      'B-': { min: 80, max: 82, color: '#3b82f6' },
      'C+': { min: 77, max: 79, color: '#f59e0b' },
      'C': { min: 73, max: 76, color: '#f59e0b' },
      'C-': { min: 70, max: 72, color: '#f59e0b' },
      'D+': { min: 67, max: 69, color: '#f97316' },
      'D': { min: 63, max: 66, color: '#f97316' },
      'D-': { min: 60, max: 62, color: '#f97316' },
      'F': { min: 0, max: 59, color: '#ef4444' }
    };

    // Initialize app
    function init() {
      const session = getSession();
      if (session) {
        currentUser = session;
        showDashboard();
      } else {
        showWelcome();
      }
      initColorPicker();
    }

    // Session management (using JavaScript variables, not localStorage due to sandbox restrictions)
    let sessionData = null;

    function saveSession(user) {
      sessionData = user;
      currentUser = user;
    }

    function getSession() {
      return sessionData;
    }

    function clearSession() {
      sessionData = null;
      currentUser = null;
    }

    // Navigation functions
    function hideAllScreens() {
      document.getElementById('welcomeScreen').classList.add('hidden');
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('registerScreen').classList.add('hidden');
      document.getElementById('dashboardScreen').classList.add('hidden');
      document.getElementById('courseDetailScreen').classList.add('hidden');
    }

    function showWelcome() {
      hideAllScreens();
      document.getElementById('welcomeScreen').classList.remove('hidden');
    }

    function showLogin() {
      hideAllScreens();
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('loginError').classList.add('hidden');
    }

    function showRegister() {
      hideAllScreens();
      document.getElementById('registerScreen').classList.remove('hidden');
      document.getElementById('registerError').classList.add('hidden');
      document.getElementById('registerSuccess').classList.add('hidden');
    }

    async function showDashboard() {
      hideAllScreens();
      document.getElementById('dashboardScreen').classList.remove('hidden');
      document.getElementById('userName').textContent = currentUser?.username || currentUser?.email || 'User';
      await loadCourses();
    }

    function showCourseDetail(course) {
      currentCourse = course;
      hideAllScreens();
      document.getElementById('courseDetailScreen').classList.remove('hidden');
      document.getElementById('detailCourseName').textContent = course.name;
      document.getElementById('detailCourseCode').textContent = course.code;
      loadAssignments(course.id);
    }

    // Auth handlers
    async function handleRegister(event) {
      event.preventDefault();
      const username = document.getElementById('registerUsername').value;
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('registerConfirmPassword').value;

      const errorEl = document.getElementById('registerError');
      const successEl = document.getElementById('registerSuccess');
      errorEl.classList.add('hidden');
      successEl.classList.add('hidden');

      if (password !== confirmPassword) {
        errorEl.textContent = 'Passwords do not match';
        errorEl.classList.remove('hidden');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password })
        });

        const data = await response.json();

        if (response.ok) {
          successEl.innerHTML = `
            <strong>‚úì Account created successfully!</strong><br>
            Please check your email (${email}) to verify your account before logging in.
          `;
          successEl.classList.remove('hidden');
          event.target.reset();
        } else {
          errorEl.textContent = data.error || 'Registration failed. Please try again.';
          errorEl.classList.remove('hidden');
        }
      } catch (error) {
        errorEl.textContent = 'Network error. Please check your connection and try again.';
        errorEl.classList.remove('hidden');
      }
    }

    async function handleLogin(event) {
      event.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      const errorEl = document.getElementById('loginError');
      errorEl.classList.add('hidden');

      try {
        const response = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (response.ok) {
          saveSession(data.user);
          await showDashboard();
        } else {
          errorEl.textContent = data.error || 'Login failed. Please check your credentials.';
          errorEl.classList.remove('hidden');
        }
      } catch (error) {
        errorEl.textContent = 'Network error. Please check your connection and try again.';
        errorEl.classList.remove('hidden');
      }
    }

    function handleLogout() {
      clearSession();
      courses = [];
      assignments = [];
      currentCourse = null;
      showWelcome();
    }

    // Course functions
    async function loadCourses() {
      const loadingEl = document.getElementById('coursesLoading');
      const gridEl = document.getElementById('coursesGrid');
      const emptyEl = document.getElementById('emptyState');

      loadingEl.classList.remove('hidden');
      gridEl.classList.add('hidden');
      emptyEl.classList.add('hidden');

      try {
        const response = await fetch(`${API_BASE}/courses?userId=${currentUser.id}`);
        const data = await response.json();

        if (response.ok) {
          courses = data.courses || [];
          renderCourses();
        } else {
          console.error('Failed to load courses:', data.error);
          courses = [];
          renderCourses();
        }
      } catch (error) {
        console.error('Error loading courses:', error);
        courses = [];
        renderCourses();
      }

      loadingEl.classList.add('hidden');
    }

    function renderCourses() {
      const gridEl = document.getElementById('coursesGrid');
      const emptyEl = document.getElementById('emptyState');

      if (courses.length === 0) {
        gridEl.classList.add('hidden');
        emptyEl.classList.remove('hidden');
        return;
      }

      gridEl.classList.remove('hidden');
      emptyEl.classList.add('hidden');

      gridEl.innerHTML = courses.map(course => {
        const colorHex = courseColors.find(c => c.value === course.color)?.hex || '#3b82f6';
        const stats = calculateCourseStats(course);

        return `
          <div class="course-card" onclick="showCourseDetail(${JSON.stringify(course).replace(/"/g, '&quot;')})">
            <div class="course-color-bar" style="background: ${colorHex};"></div>
            <div class="course-card-header">
              <div>
                <div class="course-name">${course.name}</div>
                <div class="course-code">${course.code}</div>
              </div>
            </div>
            <div class="course-stats">
              <div class="stat-row">
                <span class="stat-label">Current Grade:</span>
                <span class="stat-value">${stats.currentGrade}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Target:</span>
                <span class="stat-value">${course.target_grade}%</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Completion:</span>
                <span class="stat-value">${stats.completion}%</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function calculateCourseStats(course) {
      // This is simplified - real stats come from assignments
      return {
        currentGrade: '-',
        completion: '0',
        letterGrade: '-'
      };
    }

    function showAddCourseModal() {
      editingCourseId = null;
      document.getElementById('courseModalTitle').textContent = 'Add Course';
      document.getElementById('courseName').value = '';
      document.getElementById('courseCode').value = '';
      document.getElementById('targetGrade').value = '';
      document.getElementById('courseModalError').classList.add('hidden');
      selectColor(courseColors[0].value);
      document.getElementById('courseModal').classList.add('active');
    }

    function editCurrentCourse() {
      if (!currentCourse) return;
      editingCourseId = currentCourse.id;
      document.getElementById('courseModalTitle').textContent = 'Edit Course';
      document.getElementById('courseName').value = currentCourse.name;
      document.getElementById('courseCode').value = currentCourse.code;
      document.getElementById('targetGrade').value = currentCourse.target_grade;
      selectColor(currentCourse.color);
      document.getElementById('courseModal').classList.add('active');
    }

    function closeCourseModal() {
      document.getElementById('courseModal').classList.remove('active');
    }

    async function handleSaveCourse(event) {
      event.preventDefault();
      const name = document.getElementById('courseName').value;
      const code = document.getElementById('courseCode').value;
      const targetGrade = parseFloat(document.getElementById('targetGrade').value);
      const color = document.querySelector('.color-option.selected')?.dataset.color || 'blue';

      const errorEl = document.getElementById('courseModalError');
      errorEl.classList.add('hidden');

      try {
        const method = editingCourseId ? 'PUT' : 'POST';
        const body = editingCourseId
          ? { id: editingCourseId, name, code, target_grade: targetGrade, color }
          : { user_id: currentUser.id, name, code, target_grade: targetGrade, color };

        const response = await fetch(`${API_BASE}/courses`, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await response.json();

        if (response.ok) {
          closeCourseModal();
          if (editingCourseId) {
            // If we're on the detail page, update current course and refresh
            if (currentCourse && currentCourse.id === editingCourseId) {
              currentCourse = { ...currentCourse, name, code, target_grade: targetGrade, color };
              document.getElementById('detailCourseName').textContent = name;
              document.getElementById('detailCourseCode').textContent = code;
              document.getElementById('targetGrade').textContent = `${targetGrade}%`;
            }
          }
          await loadCourses();
        } else {
          errorEl.textContent = data.error || 'Failed to save course';
          errorEl.classList.remove('hidden');
        }
      } catch (error) {
        errorEl.textContent = 'Network error. Please try again.';
        errorEl.classList.remove('hidden');
      }
    }

    async function deleteCurrentCourse() {
      if (!currentCourse || !confirm(`Are you sure you want to delete "${currentCourse.name}"? This will also delete all assignments.`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/courses?id=${currentCourse.id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          await showDashboard();
        } else {
          alert('Failed to delete course. Please try again.');
        }
      } catch (error) {
        alert('Network error. Please try again.');
      }
    }

    // Assignment functions
    async function loadAssignments(courseId) {
      const loadingEl = document.getElementById('assignmentsLoading');
      const listEl = document.getElementById('assignmentsList');
      const emptyEl = document.getElementById('emptyAssignments');

      loadingEl.classList.remove('hidden');
      listEl.classList.add('hidden');
      emptyEl.classList.add('hidden');

      try {
        const response = await fetch(`${API_BASE}/assignments?courseId=${courseId}`);
        const data = await response.json();

        if (response.ok) {
          assignments = data.assignments || [];
          renderAssignments();
          updateCalculations();
        } else {
          console.error('Failed to load assignments:', data.error);
          assignments = [];
          renderAssignments();
        }
      } catch (error) {
        console.error('Error loading assignments:', error);
        assignments = [];
        renderAssignments();
      }

      loadingEl.classList.add('hidden');
    }

    function renderAssignments() {
      const listEl = document.getElementById('assignmentsList');
      const emptyEl = document.getElementById('emptyAssignments');

      if (assignments.length === 0) {
        listEl.classList.add('hidden');
        emptyEl.classList.remove('hidden');
        return;
      }

      listEl.classList.remove('hidden');
      emptyEl.classList.add('hidden');

      listEl.innerHTML = assignments.map(assignment => `
        <div class="assignment-item">
          <div class="assignment-info">
            <div class="assignment-name">${assignment.name}</div>
            <div class="assignment-details">
              ${assignment.type} ‚Ä¢ Grade: ${assignment.grade}% ‚Ä¢ Weight: ${assignment.weight}%
              ${assignment.due_date ? ` ‚Ä¢ Due: ${new Date(assignment.due_date).toLocaleDateString()}` : ''}
            </div>
          </div>
          <div class="assignment-actions">
            <button class="icon-btn" onclick="editAssignment(${assignment.id})" title="Edit">‚úèÔ∏è</button>
            <button class="icon-btn" onclick="deleteAssignment(${assignment.id})" title="Delete">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function showAddAssignmentModal() {
      editingAssignmentId = null;
      document.getElementById('assignmentModalTitle').textContent = 'Add Assignment';
      document.getElementById('assignmentName').value = '';
      document.getElementById('assignmentGrade').value = '';
      document.getElementById('assignmentWeight').value = '';
      document.getElementById('assignmentType').value = '';
      document.getElementById('assignmentDate').value = '';
      document.getElementById('assignmentModalError').classList.add('hidden');
      document.getElementById('assignmentModal').classList.add('active');
    }

    function editAssignment(assignmentId) {
      const assignment = assignments.find(a => a.id === assignmentId);
      if (!assignment) return;

      editingAssignmentId = assignmentId;
      document.getElementById('assignmentModalTitle').textContent = 'Edit Assignment';
      document.getElementById('assignmentName').value = assignment.name;
      document.getElementById('assignmentGrade').value = assignment.grade;
      document.getElementById('assignmentWeight').value = assignment.weight;
      document.getElementById('assignmentType').value = assignment.type;
      document.getElementById('assignmentDate').value = assignment.due_date || '';
      document.getElementById('assignmentModal').classList.add('active');
    }

    function closeAssignmentModal() {
      document.getElementById('assignmentModal').classList.remove('active');
    }

    async function handleSaveAssignment(event) {
      event.preventDefault();
      const name = document.getElementById('assignmentName').value;
      const grade = parseFloat(document.getElementById('assignmentGrade').value);
      const weight = parseFloat(document.getElementById('assignmentWeight').value);
      const type = document.getElementById('assignmentType').value;
      const dueDate = document.getElementById('assignmentDate').value;

      const errorEl = document.getElementById('assignmentModalError');
      errorEl.classList.add('hidden');

      // Validate total weight
      const totalWeight = assignments
        .filter(a => editingAssignmentId ? a.id !== editingAssignmentId : true)
        .reduce((sum, a) => sum + a.weight, 0) + weight;

      if (totalWeight > 100) {
        errorEl.textContent = `Total weight cannot exceed 100%. Current total: ${totalWeight}%`;
        errorEl.classList.remove('hidden');
        return;
      }

      try {
        const method = editingAssignmentId ? 'PUT' : 'POST';
        const body = editingAssignmentId
          ? { id: editingAssignmentId, name, grade, weight, type, due_date: dueDate || null }
          : { course_id: currentCourse.id, name, grade, weight, type, due_date: dueDate || null };

        const response = await fetch(`${API_BASE}/assignments`, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await response.json();

        if (response.ok) {
          closeAssignmentModal();
          await loadAssignments(currentCourse.id);
        } else {
          errorEl.textContent = data.error || 'Failed to save assignment';
          errorEl.classList.remove('hidden');
        }
      } catch (error) {
        errorEl.textContent = 'Network error. Please try again.';
        errorEl.classList.remove('hidden');
      }
    }

    async function deleteAssignment(assignmentId) {
      const assignment = assignments.find(a => a.id === assignmentId);
      if (!assignment || !confirm(`Are you sure you want to delete "${assignment.name}"?`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/assignments?id=${assignmentId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          await loadAssignments(currentCourse.id);
        } else {
          alert('Failed to delete assignment. Please try again.');
        }
      } catch (error) {
        alert('Network error. Please try again.');
      }
    }

    // Calculations
    function updateCalculations() {
      if (assignments.length === 0) {
        document.getElementById('currentGrade').textContent = '-';
        document.getElementById('targetGrade').textContent = currentCourse ? `${currentCourse.target_grade}%` : '-';
        document.getElementById('completionPercent').textContent = '0%';
        document.getElementById('requiredFinal').textContent = '-';
        return;
      }

      const totalWeight = assignments.reduce((sum, a) => sum + a.weight, 0);
      const weightedGrade = assignments.reduce((sum, a) => sum + (a.grade * a.weight), 0);
      const currentGrade = totalWeight > 0 ? weightedGrade / totalWeight : 0;
      const completion = totalWeight;
      const remaining = 100 - totalWeight;

      const letterGrade = getLetterGrade(currentGrade);
      document.getElementById('currentGrade').innerHTML = `
        ${currentGrade.toFixed(1)}% 
        <span class="grade-badge" style="background: ${letterGrade.color}; margin-left: 8px;">${letterGrade.letter}</span>
      `;
      
      document.getElementById('targetGrade').textContent = currentCourse ? `${currentCourse.target_grade}%` : '-';
      document.getElementById('completionPercent').textContent = `${completion.toFixed(1)}%`;

      if (remaining > 0 && currentCourse) {
        const requiredFinal = ((currentCourse.target_grade - (currentGrade * completion / 100)) / remaining) * 100;
        const requiredLetterGrade = getLetterGrade(requiredFinal);
        document.getElementById('requiredFinal').innerHTML = `
          ${requiredFinal.toFixed(1)}% 
          <span class="grade-badge" style="background: ${requiredLetterGrade.color}; margin-left: 8px; font-size: 11px;">${requiredLetterGrade.letter}</span>
        `;
      } else {
        document.getElementById('requiredFinal').textContent = 'N/A';
      }
    }

    function getLetterGrade(percentage) {
      for (const [letter, range] of Object.entries(gradeScale)) {
        if (percentage >= range.min && percentage <= range.max) {
          return { letter, color: range.color };
        }
      }
      return { letter: 'F', color: gradeScale.F.color };
    }

    // Color picker
    function initColorPicker() {
      const picker = document.getElementById('colorPicker');
      picker.innerHTML = courseColors.map(color => `
        <div class="color-option" 
             data-color="${color.value}" 
             style="background: ${color.hex};" 
             onclick="selectColor('${color.value}')"
             title="${color.name}">
        </div>
      `).join('');
    }

    function selectColor(colorValue) {
      document.querySelectorAll('.color-option').forEach(el => {
        el.classList.remove('selected');
        if (el.dataset.color === colorValue) {
          el.classList.add('selected');
        }
      });
    }

    // Initialize on load
    init();
  </script>
</body>
</html>